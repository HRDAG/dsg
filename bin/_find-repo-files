#!/usr/bin/python3
# Authors:     PB
# Maintainers: PB
# Copyright:   2024, HRDAG, GPL v2 or later
#
# This is a helper script for btrsnap. It probably shouldn't be called
# otherwise.
#
# It must be on the PATH. It must be in python bc `find` and `stat`
# are totally different on MacOS-BSD and gnu. Even python's `stat` returns 
# fractional seconds in MacOS but integer seconds on gnu/linux. sheesh.
# ============================================
from pathlib import Path
from datetime import datetime
import os
import re
import argparse

ig = re.compile(r'\..*ignore')
dts = re.compile(r'([.]\d+)$')   # the seconds part of a date string, if it exists
# TODO: move the definition of datadirs to .btrsnap/config 
datadirs = {'input', 'output', 'frozen', 'note'}


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("-p", "--path", required=True)
    args = parser.parse_args()

    start = Path(args.path)
    assert start.exists()

    left = len(start.parts)
    recs = list()

    for root, dirs, files in os.walk(start):
        rightparts = set(Path(root).parts[left:])
        if not rightparts & datadirs: 
            continue
        for f in [f for f in files if not ig.search(f)]:
            fullpath = Path(root) / f
            stat = os.lstat(fullpath)
            if fullpath.is_symlink():
                sz = 0
                targ_full = fullpath.resolve()
                targ = targ_full.relative_to(start.absolute())
            else:
                sz = stat.st_size
                targ = None 
            fullpath = fullpath.absolute()
            dt = datetime.utcfromtimestamp(stat.st_mtime).isoformat()
            dt = dts.sub('', dt)
            assert len(dt) == 19
            recs.append(f"{fullpath}|{targ}|{sz}|{dt}")

    print('||'.join(recs))

# done
